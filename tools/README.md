This directory provides a set of tools for generating middle-box–view datasets, as well as extracting ground-truth loss events and the per-hop arrival time of each packet. We hope these tools can support the design of transparent transport-enhancement mechanisms deployed on middle-boxes.

## Get middle-box dataset from logs: `log2trace.py`

This script produces a middle-box–view dataset file that contains basic information for packets in both directions: timestamp, id, and size.



Usage example:
```bash
# get logs under an environment using run.py with --log-level info, and --pemi --pemi-proxy-only enabled(to get the mid log)
sudo -E python3 mininet/run.py --loss1 1 --log-level info --pemi --pemi-proxy-only quiche_rtc --video-long 1
# analyze logs to get traces
python3 tools/log2trace.py --log_file r1.log
```

## Analyzing logs: analyze_log.py

`tools/analyze_log.py` analyzes the log files generated by `run.py` to extract the timestamps of each packet at different hops, marking those that did not arrive with -1. This can help identify where packets were lost.
Additionally, in the analysis, we treat the first packet sent by the receiver (currently always mininet's h1, i.e., the client) after receiving a data packet as the reply to that data packet. By correlating their timestamps observed at the PEMI, we can calculate the middlebox-endpoint RTT ground truth.
Note that the timestamps between the mid and peers are not comparable, as they are not synchronized (so the one-way delay cannot be directly calculated).



Usage example:
```bash
# get logs under an environment using run.py with --log-level info, and --pemi --pemi-proxy-only enabled(to get the mid log)
sudo -E python3 mininet/run.py --loss1 1 --log-level info --pemi --pemi-proxy-only quiche_rtc --video-long 1
# analyze logs to get traces
python3 tools/analyze_log.py --log-dir .
```

The script will generate a `summary_log.csv` file with the following format:

```
direction,num,send_time,mid_time,recv_time,id,replyed
h1->,1,0.0,0.0,26.3,cf00000001103de00000000000000000,[]
h1->,2,1000.1,999.924115,1026.2,c900000001103de00000000000000000,[]
<-h2,3,1026.2,1050.0821760000001,1052.3,f000000001148edb5df6afa99e3f102a,
h1->,4,1052.4,1052.255158,1078.5,cd000000011497d30000000000000000,['f000000001148edb5df6afa99e3f102a']
<-h2,5,1079.5,1103.3393520000002,1105.6,c000000001148edbe4a5338872ef0263,
<-h2,6,1079.5,1103.384605,1105.7,ed00000001148edbc7debb8f49c0cec3,
h1->,7,1105.8,1105.6802850000001,1131.9,c6000000011497d30986444b1395c0df,['c000000001148edbe4a5338872ef0263', 'ed00000001148edbc7debb8f49c0cec3']
...
```

## Analyzing pcaps: analyze_pcap.py

Note: we recommend using the log-based approach described above, as the capture may miss some packets.

When running tests with `run.py` and enabling `--cap`, the script will try to collect pcap files from all nodes and store them under the `pcap/` directory. You can then analyze these pcap files using `tools/analyze_pcap.py`.  

Usage example:
```bash
# capture pcaps using run.py with --cap
sudo -E python3 mininet/run.py --loss1 1 --cap quiche_rtc --video-long 1
# analyze pcaps
python3 tools/analyze_pcap.py --pcap_dir pcap
```

By default, `analyze_pcap.py` verifies packet-count relationship. For example, the number of packets observed at `h2` should match the number of packets sent from `h1` and received by `h2`, plus the packets sent out by `h2`. This serves as a coarse check to make sure that both capturing and analysis are correct.  
Using `--pemi` disables this check because PEMI may retransmit packets.

The analysis will generate `h1-h2.csv` and `h2-h1.csv`, and finally produce `summary.csv`, which has the following format:

```
direction,num,size,send_time,r1_time,recv_time,id
h1->,1,1242,0.0,0.0,25.1,c40000000110ffdb0000000000000000
<-h2,2,131,50.3,51.3,51.3,f000000001142483f681cf01cdd12bde
h1->,3,1242,52.5,52.5,77.5,c4000000011435180000000000000000
...
```
